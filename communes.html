<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="FD" />


<title>communes</title>

<script src="communes_files/header-attrs-2.7/header-attrs.js"></script>
<script src="communes_files/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="communes_files/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="communes_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="communes_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="communes_files/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="communes_files/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="communes_files/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="communes_files/tocify-1.9.1/jquery.tocify.js"></script>
<script src="communes_files/navigation-1.1/tabsets.js"></script>
<script src="communes_files/navigation-1.1/codefolding.js"></script>
<link href="communes_files/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="communes_files/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>








<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>



<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-sm-12 col-md-4 col-lg-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-sm-12 col-md-8 col-lg-9">




<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">communes</h1>
<h4 class="author">FD</h4>

</div>


<div id="initializations" class="section level1">
<h1>Initializations</h1>
<div id="load-data" class="section level2">
<h2>Load data</h2>
<p>Niveau de vie par commune</p>
<p>Source : <a href="https://www.data.gouv.fr/fr/datasets/niveau-de-vie-des-francais-par-commune/" class="uri">https://www.data.gouv.fr/fr/datasets/niveau-de-vie-des-francais-par-commune/</a></p>
<blockquote>
<p>L’Insee a publié les niveaux de vie des ménages par commune pour l’année 2014. Le dispositif d’analyse, appelé Filosofi, permet de détailler où se situent les zones de pauvreté en France. Date de mise à jour : 31 octobre 2017</p>
</blockquote>
<pre class="r"><code>URL &lt;- &quot;https://www.data.gouv.fr/fr/datasets/r/16fce6ae-1907-442d-99b2-9ddcf6c41b03&quot;
dataFile &lt;- paste0(&quot;data/niveauVie.csv&quot;) # name file with today&#39;s date
download.file(URL, dataFile) # download file from repo
dat.niveauVie &lt;- read.csv(dataFile, sep = &quot;;&quot;, stringsAsFactors = FALSE, dec = &quot;,&quot;)

head(dat.niveauVie)</code></pre>
<p>Vaccination par commune</p>
<pre class="r"><code>URL &lt;- &quot;https://datavaccin-covid.ameli.fr/explore/dataset/donnees-de-vaccination-par-commune/download/?format=csv&amp;timezone=Europe/Berlin&amp;lang=fr&amp;use_labels_for_header=true&amp;csv_separator=%3B&quot;
dataFile &lt;- paste0(&quot;data/vacciCommunes.csv&quot;) # name file with today&#39;s date
download.file(URL, dataFile) # download file from repo
dat.vaccin &lt;- read.csv(dataFile, sep = &quot;;&quot;, stringsAsFactors = FALSE, dec = &quot;,&quot;)
head(dat.vaccin)</code></pre>
</div>
<div id="clean-data" class="section level2">
<h2>Clean data</h2>
<pre class="r"><code># Final week in the data
maxWeek &lt;- max(unique(dat.vaccin$semaine_injection))

# Select only data for the final week
dat.vaccin.final &lt;- dat.vaccin[which(dat.vaccin$semaine_injection == maxWeek), ]</code></pre>
<p>Merge the two datasets</p>
<pre class="r"><code>nrow(dat.vaccin.final)

names(dat.niveauVie)
names(dat.niveauVie) &lt;- c(&quot;commune_residence&quot;, &quot;libelle_commune&quot;, &quot;med14&quot;)
nrow(dat.niveauVie)

dat.all &lt;- merge(dat.niveauVie, dat.vaccin.final, by = &quot;commune_residence&quot;)
nrow(dat.all)</code></pre>
<p>Add region information</p>
<pre class="r"><code>dat.all$dep &lt;- substr(dat.all$commune_residence, start = 1, stop = 2)
unique(dat.all$dep)

# Initialize region data
dat.all$region &lt;- NA
# Get region from departement information
dat.all[base::is.element(dat.all$dep, c(&quot;13&quot;, &quot;83&quot;, &quot;84&quot;)), &quot;region&quot;] &lt;- &quot;PACA&quot;
dat.all[base::is.element(dat.all$dep, c(&quot;75&quot;, &quot;91&quot;, &quot;92&quot;, &quot;93&quot;, &quot;94&quot;, &quot;95&quot;)), &quot;region&quot;] &lt;- &quot;IDF&quot;
dat.all[base::is.element(dat.all$dep, c(&quot;69&quot;)), &quot;region&quot;] &lt;- &quot;ARA&quot;</code></pre>
<p>Remove NAs</p>
<pre class="r"><code>dat &lt;- dat.all[which(!is.na(dat.all$effectif_cumu_1_inj) &amp; !is.na(dat.all$effectif_cumu_termine) &amp; !is.na(dat.all$population_carto)), ]
nrow(dat)</code></pre>
<p>Dictionary of age classes</p>
<pre class="r"><code>dic.ages &lt;- as.character(unique(dat$classe_age))
names(dic.ages) &lt;- unique(dat$libelle_classe_age)
dic.ages</code></pre>
</div>
<div id="plot-settings" class="section level2">
<h2>Plot settings</h2>
<pre class="r"><code>library(RColorBrewer)</code></pre>
<p>Region colors and pch</p>
<pre class="r"><code>colRegion &lt;- brewer.pal(name = &quot;Set2&quot;, n = 3)
names(colRegion) &lt;- c(&quot;IDF&quot;, &quot;ARA&quot;, &quot;PACA&quot;)

pchRegion &lt;- 16:18
names(pchRegion) &lt;- names(colRegion)</code></pre>
<p>Age colors</p>
<pre class="r"><code>ages &lt;- unique(dat$libelle_classe_age)
colAge &lt;- brewer.pal(name = &quot;Dark2&quot;, n = length(ages))
names(colAge) &lt;- ages</code></pre>
</div>
</div>
<div id="model-and-plot" class="section level1">
<h1>Model and plot</h1>
<div id="models" class="section level2">
<h2>Models</h2>
<pre class="r"><code>mdl1D &lt;- glm(formula = cbind(effectif_cumu_1_inj, population_carto - effectif_cumu_1_inj) ~ med14 + classe_age + classe_age*med14 + region, data = dat, family = binomial(link = &quot;logit&quot;))

mdl1D.noregion &lt;- glm(formula = cbind(effectif_cumu_1_inj, population_carto - effectif_cumu_1_inj) ~ med14 + classe_age, data = dat, family = binomial(link = &quot;logit&quot;))

mdlFin &lt;- glm(formula = cbind(effectif_cumu_termine, population_carto - effectif_cumu_termine) ~ med14 + classe_age + classe_age*med14 + region, data = dat, family = binomial(link = &quot;logit&quot;))

mdlFin.noregion &lt;- glm(formula = cbind(effectif_cumu_termine, population_carto - effectif_cumu_termine) ~ med14 + classe_age, data = dat, family = binomial(link = &quot;logit&quot;))

summary(mdl1D)</code></pre>
<pre><code>## 
## Call:
## glm(formula = cbind(effectif_cumu_1_inj, population_carto - effectif_cumu_1_inj) ~ 
##     med14 + classe_age + classe_age * med14 + region, family = binomial(link = &quot;logit&quot;), 
##     data = dat)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -59.953   -3.624    0.085    2.894   73.420  
## 
## Coefficients:
##                            Estimate Std. Error  z value Pr(&gt;|z|)    
## (Intercept)              -4.459e+00  1.127e-02 -395.808  &lt; 2e-16 ***
## med14                     7.166e-05  4.415e-07  162.318  &lt; 2e-16 ***
## classe_age20-39           2.539e+00  1.233e-02  205.936  &lt; 2e-16 ***
## classe_age40-54           3.239e+00  1.270e-02  254.975  &lt; 2e-16 ***
## classe_age55-64           4.074e+00  1.386e-02  293.838  &lt; 2e-16 ***
## classe_age65-74           4.578e+00  1.505e-02  304.111  &lt; 2e-16 ***
## classe_age75 et +         4.739e+00  1.525e-02  310.691  &lt; 2e-16 ***
## classe_ageTOUT_AGE        3.019e+00  1.152e-02  262.105  &lt; 2e-16 ***
## regionIDF                -4.928e-02  1.439e-03  -34.242  &lt; 2e-16 ***
## regionPACA               -2.191e-01  1.717e-03 -127.585  &lt; 2e-16 ***
## med14:classe_age20-39     3.470e-06  4.917e-07    7.056 1.71e-12 ***
## med14:classe_age40-54    -4.721e-06  5.114e-07   -9.231  &lt; 2e-16 ***
## med14:classe_age55-64    -1.818e-05  5.677e-07  -32.019  &lt; 2e-16 ***
## med14:classe_age65-74    -2.546e-05  6.220e-07  -40.930  &lt; 2e-16 ***
## med14:classe_age75 et +  -2.995e-05  6.238e-07  -48.015  &lt; 2e-16 ***
## med14:classe_ageTOUT_AGE -1.244e-05  4.549e-07  -27.342  &lt; 2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 3590876  on 2199  degrees of freedom
## Residual deviance:  170608  on 2184  degrees of freedom
## AIC: 188781
## 
## Number of Fisher Scoring iterations: 4</code></pre>
<pre class="r"><code>summary(mdlFin)</code></pre>
<pre><code>## 
## Call:
## glm(formula = cbind(effectif_cumu_termine, population_carto - 
##     effectif_cumu_termine) ~ med14 + classe_age + classe_age * 
##     med14 + region, family = binomial(link = &quot;logit&quot;), data = dat)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -42.917   -2.950   -0.187    2.296   51.658  
## 
## Coefficients:
##                            Estimate Std. Error  z value Pr(&gt;|z|)    
## (Intercept)              -6.158e+00  2.336e-02 -263.615  &lt; 2e-16 ***
## med14                     7.269e-05  9.040e-07   80.414  &lt; 2e-16 ***
## classe_age20-39           3.382e+00  2.411e-02  140.252  &lt; 2e-16 ***
## classe_age40-54           4.117e+00  2.411e-02  170.749  &lt; 2e-16 ***
## classe_age55-64           5.097e+00  2.449e-02  208.116  &lt; 2e-16 ***
## classe_age65-74           5.620e+00  2.504e-02  224.417  &lt; 2e-16 ***
## classe_age75 et +         5.919e+00  2.523e-02  234.625  &lt; 2e-16 ***
## classe_ageTOUT_AGE        4.120e+00  2.349e-02  175.379  &lt; 2e-16 ***
## regionIDF                -5.683e-03  1.587e-03   -3.581 0.000342 ***
## regionPACA                7.114e-02  1.879e-03   37.862  &lt; 2e-16 ***
## med14:classe_age20-39    -1.677e-05  9.370e-07  -17.894  &lt; 2e-16 ***
## med14:classe_age40-54    -1.791e-05  9.386e-07  -19.084  &lt; 2e-16 ***
## med14:classe_age55-64    -2.460e-05  9.581e-07  -25.673  &lt; 2e-16 ***
## med14:classe_age65-74    -2.226e-05  9.855e-07  -22.590  &lt; 2e-16 ***
## med14:classe_age75 et +  -2.605e-05  9.912e-07  -26.277  &lt; 2e-16 ***
## med14:classe_ageTOUT_AGE -2.150e-05  9.109e-07  -23.605  &lt; 2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 3297582  on 2199  degrees of freedom
## Residual deviance:   93538  on 2184  degrees of freedom
## AIC: 111223
## 
## Number of Fisher Scoring iterations: 4</code></pre>
<pre class="r"><code># Fit</code></pre>
<pre class="r"><code>newdata &lt;- expand.grid(med14 = seq(min(dat$med14), max(dat$med14), length.out = 100), classe_age = sort(unique(dat$classe_age)), region = unique(dat$region))
nrow(newdata)

newdata.noregion &lt;- expand.grid(med14 = seq(min(dat$med14), max(dat$med14), length.out = 100), classe_age = sort(unique(dat$classe_age)))

ndt &lt;- newdata
ndt$prd1D &lt;- predict(mdl1D, newdata = newdata, type = &quot;response&quot;)
ndt$prdFin &lt;- predict(mdlFin, newdata = newdata, type = &quot;response&quot;)

ndt.noregion &lt;- newdata.noregion
ndt.noregion$prd1D &lt;- predict(mdl1D.noregion, newdata = newdata.noregion, type = &quot;response&quot;)
ndt.noregion$prdFin &lt;- predict(mdlFin.noregion, newdata = newdata.noregion, type = &quot;response&quot;)</code></pre>
</div>
<div id="plot" class="section level2">
<h2>Plot</h2>
<pre class="r"><code>marWithDetails &lt;- c(6, 6, 3, 6.75)

textDetails &lt;- &quot;Figure @flodebarre, données trouvées par @humeursdevictor
Code: https://github.com/flodebarre/covid_vaccination/blob/main/communes.Rmd
Données vaccination : https://datavaccin-covid.ameli.fr/explore/dataset/donnees-de-vaccination-par-commune
Données revenus : https://www.data.gouv.fr/fr/datasets/niveau-de-vie-des-francais-par-commune/&quot;</code></pre>
<div id="tous-ages" class="section level3">
<h3>Tous ages</h3>
<pre class="r"><code>cla &lt;- &quot;Tout âge&quot;
par(mar = marWithDetails - c(0, 0, 0, 3), las = 1, mgp = c(1.75, 0.4, 0), tck = -0.02)

  subdat &lt;- dat[which(dat$libelle_classe_age == cla), ]
  plot(subdat$med14, subdat$taux_cumu_1_inj, 
       ylim = c(0, 0.7), 
       xlab = &quot;Revenu médian dans la commune&quot;, ylab = &quot;Proportion de la population
ayant reçu au moins une infection&quot;, 
       yaxs = &quot;i&quot;, 
       col = adjustcolor(colRegion[subdat$region], alpha.f = 0.5), 
       pch = pchRegion[subdat$region],
frame.plot = FALSE)
  axis(4)
  title(main = &quot;Au moins une injection, tous âges&quot;)
  mtext(textDetails, side = 1, line = 4.5, cex = 0.6, adj = 0, col = gray(0.4))
  legend(&quot;bottomright&quot;, legend = names(colRegion), col = colRegion, pch = pchRegion[names(colRegion)], bty = &quot;n&quot;, title = &quot;Regions&quot;)
  
  
# Add legends
x1 &lt;- max(dat$med14)
d1 &lt;- dat[which(dat$med14 == x1), ]

x2 &lt;- min(dat$med14)
d2 &lt;- dat[which(dat$med14 == x2), ]

x3 &lt;- 35161
d3 &lt;- dat[which(dat$med14 == x3), ]

dy &lt;- 0.01
text(x = c(x1, x2, x3), 
     y = c(as.numeric(d1[d1$classe_age == &quot;TOUT_AGE&quot;, &quot;taux_cumu_1_inj&quot;]), as.numeric(d2[d2$classe_age == &quot;TOUT_AGE&quot;, &quot;taux_cumu_1_inj&quot;]), as.numeric(d3[d3$classe_age == &quot;TOUT_AGE&quot;, &quot;taux_cumu_1_inj&quot;])) - dy, 
     labels = c(d1[1, &quot;libelle_commune.x&quot;], d2[1, &quot;libelle_commune.x&quot;], d3[1, &quot;libelle_commune.x&quot;]), 
     adj = c(1, 0.5), srt = 90, cex = 0.5)</code></pre>
<p><img src="communes_files/figure-html/unnamed-chunk-14-1.png" width="672" /></p>
</div>
<div id="au-moins-une-injection" class="section level3">
<h3>Au moins une injection</h3>
<p>(Pour faire les choses proprement il faudrait une boucle)</p>
<pre class="r"><code>par(mar = marWithDetails, las = 1, mgp = c(1.75, 0.4, 0), tck = -0.02)
alf &lt;- 0.4
lwd.pred &lt;- 1.5

# Remove all ages
tmp &lt;- dat[which(dat$classe_age != &quot;TOUT_AGE&quot;),]

plot(tmp$med14, tmp$taux_cumu_1_inj, 
     xlab = &quot;Revenu médian dans la commune&quot;, ylab = &quot;Proportion de la classe d&#39;âge 
ayant reçu au moins eu une injection&quot;, 
     yaxs = &quot;i&quot;, frame.plot = FALSE, ylim = c(0, 1),
     type = &quot;n&quot;, axes = FALSE
)
axis(1)
axis(2, pos = 10200)
par(xpd = FALSE)
title(main = &quot;Au moins une injection, par classe d&#39;âge&quot;)

for(i in seq(0, 1, by = 0.1)){
  abline(h = i, lwd = 0.5, col = gray(0.8))
}


# Legend communes
dx &lt;- 400
dy &lt;- 0.025
cexleg &lt;- 0.6
colRec &lt;- gray(0.925)

# max
xmax &lt;- max(dat$med14)
datmax &lt;- dat[which(dat$med14 == xmax), ]
rect(xleft = xmax - dx, xright = xmax + dx,
     ybottom = as.numeric(min(datmax$taux_cumu_1_inj)) - dy, ytop = as.numeric(max(datmax$taux_cumu_1_inj)) + dy, col = colRec, border = gray(0, 0))
text(x = xmax - dx, y = (as.numeric(max(datmax$taux_cumu_1_inj)) + as.numeric(min(datmax$taux_cumu_1_inj)) )/2, labels = datmax[1, &quot;libelle_commune.x&quot;], cex = cexleg, adj = c(0.5, 0), srt = 90)

# min
xmin &lt;- min(dat$med14)
datmin &lt;- dat[which(dat$med14 == xmin), ]
rect(xleft = xmin - dx, xright = xmin + dx,
     ybottom = as.numeric(min(datmin$taux_cumu_1_inj)) - dy, ytop = as.numeric(max(datmin$taux_cumu_1_inj)) + dy, col = colRec, border = gray(0, 0))
text(x = xmin - dx, y = (as.numeric(max(datmin$taux_cumu_1_inj)) + as.numeric(min(datmin$taux_cumu_1_inj)) )/2, labels = datmin[1, &quot;libelle_commune.x&quot;], cex = cexleg, adj = c(0.5, 0), srt = 90)

# Intermediate
dat3 &lt;- dat[dat$med14&gt;35000 &amp; dat$med14 &lt; 36000,]
x3 &lt;- unique(dat3$med14)
rect(xleft = x3 - dx, xright = x3 + dx,
     ybottom = as.numeric(min(dat3$taux_cumu_1_inj)) - dy, ytop = as.numeric(max(dat3$taux_cumu_1_inj)) + dy, col = colRec, border = gray(0, 0))
text(x = x3 - dx, y = (as.numeric(max(dat3$taux_cumu_1_inj)) + as.numeric(min(dat3$taux_cumu_1_inj)) )/2, labels = dat3[1, &quot;libelle_commune.x&quot;], cex = cexleg, adj = c(0.5, 0), srt = 90)

mtext(1, line = 4.5, text = textDetails, cex = 0.6, adj = 0, col = gray(0.6))

par(xpd = TRUE)

points(tmp$med14, tmp$taux_cumu_1_inj, 
     col = adjustcolor(colAge[tmp$libelle_classe_age], alpha.f = alf), 
     pch = pchRegion[tmp$region])
# Get age classes and sort them by proportion vaccinated for the legend
mns &lt;- aggregate(as.numeric(dat$taux_cumu_termine), by = list(dat$libelle_classe_age), FUN = mean, na.rm = TRUE)
mns2 &lt;- mns[sort(mns$x, index.return = TRUE, decreasing = TRUE)$ix,]
mns2 &lt;- mns2[mns2$Group.1 != &quot;Tout âge&quot;, ]

legend(x = 1.05*max(tmp$med14), y = 0.5, 
       legend = c(mns2$Group.1, names(pchRegion)), 
       col = c(colAge[mns2$Group.1], rep(gray(0.5), 3)), 
       pch = c(rep(NA, nrow(mns2)), pchRegion), 
       lwd = c(rep(lwd.pred, nrow(mns2)), rep(0, length(pchRegion))), 
       bty = &quot;n&quot;, cex = 0.7, pt.cex = 1, xjust = 0, yjust = 0.5)

for(age in ages[ages!=&quot;Tout âge&quot;]){
  agcl &lt;- dic.ages[age] # Get corresponding age class
  # Get predicted data for this age class (no region)
  subd &lt;- ndt.noregion[ndt.noregion$classe_age == agcl,]
  lines(subd$med14, subd$prd1D, col = colAge[age], lwd = lwd.pred)
}</code></pre>
<p><img src="communes_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
</div>
<div id="vaccination-terminée" class="section level3">
<h3>Vaccination terminée</h3>
<pre class="r"><code>par(mar = marWithDetails, las = 1, mgp = c(1.75, 0.4, 0), tck = -0.02)

plot(tmp$med14, tmp$taux_cumu_termine, 
     xlab = &quot;Revenu médian dans la commune&quot;, ylab = &quot;Proportion de la classe d&#39;âge 
dont la vaccination est terminée&quot;, 
     yaxs = &quot;i&quot;, frame.plot = FALSE, ylim = c(0, 1),
     type = &quot;n&quot;, axes = FALSE
)
axis(1)
axis(2, pos = 10200)
par(xpd = FALSE)
title(main = &quot;Vaccination terminée, par classe d&#39;âge&quot;)

for(i in seq(0, 1, by = 0.1)){
  abline(h = i, lwd = 0.5, col = gray(0.8))
}


# Legend communes
dx &lt;- 400
dy &lt;- 0.025
cexleg &lt;- 0.6
colRec &lt;- gray(0.925)

# max
xmax &lt;- max(dat$med14)
datmax &lt;- dat[which(dat$med14 == xmax), ]
rect(xleft = xmax - dx, xright = xmax + dx,
     ybottom = as.numeric(min(datmax$taux_cumu_termine)) - dy, ytop = as.numeric(max(datmax$taux_cumu_termine)) + dy, col = colRec, border = gray(0, 0))
text(x = xmax - dx, y = (as.numeric(max(datmax$taux_cumu_termine)) + as.numeric(min(datmax$taux_cumu_termine)) )/2, labels = datmax[1, &quot;libelle_commune.x&quot;], cex = cexleg, adj = c(0.5, 0), srt = 90)

# min
xmin &lt;- min(dat$med14)
datmin &lt;- dat[which(dat$med14 == xmin), ]
rect(xleft = xmin - dx, xright = xmin + dx,
     ybottom = as.numeric(min(datmin$taux_cumu_termine)) - dy, ytop = as.numeric(max(datmin$taux_cumu_termine)) + dy, col = colRec, border = gray(0, 0))
text(x = xmin - dx, y = (as.numeric(max(datmin$taux_cumu_termine)) + as.numeric(min(datmin$taux_cumu_termine)) )/2, labels = datmin[1, &quot;libelle_commune.x&quot;], cex = cexleg, adj = c(0.5, 0), srt = 90)

# Intermediate
dat3 &lt;- dat[dat$med14&gt;35000 &amp; dat$med14 &lt; 36000,]
x3 &lt;- unique(dat3$med14)
rect(xleft = x3 - dx, xright = x3 + dx,
     ybottom = as.numeric(min(dat3$taux_cumu_termine)) - dy, ytop = as.numeric(max(dat3$taux_cumu_termine)) + dy, col = colRec, border = gray(0, 0))
text(x = x3 - dx, y = (as.numeric(max(dat3$taux_cumu_termine)) + as.numeric(min(dat3$taux_cumu_termine)) )/2, labels = dat3[1, &quot;libelle_commune.x&quot;], cex = cexleg, adj = c(0.5, 0), srt = 90)

mtext(1, line = 4.5, text = textDetails, cex = 0.6, adj = 0, col = gray(0.6))

par(xpd = TRUE)

points(tmp$med14, tmp$taux_cumu_termine, 
     col = adjustcolor(colAge[tmp$libelle_classe_age], alpha.f = alf), 
     pch = pchRegion[tmp$region])
# Get age classes and sort them by proportion vaccinated for the legend
mns &lt;- aggregate(as.numeric(dat$taux_cumu_termine), by = list(dat$libelle_classe_age), FUN = mean, na.rm = TRUE)
mns2 &lt;- mns[sort(mns$x, index.return = TRUE, decreasing = TRUE)$ix,]
mns2 &lt;- mns2[mns2$Group.1 != &quot;Tout âge&quot;, ]

legend(x = 1.05*max(tmp$med14), y = 0.5, 
       legend = c(mns2$Group.1, names(pchRegion)), 
       col = c(colAge[mns2$Group.1], rep(gray(0.5), 3)), 
       pch = c(rep(NA, nrow(mns2)), pchRegion), 
       lwd = c(rep(lwd.pred, nrow(mns2)), rep(0, length(pchRegion))), 
       bty = &quot;n&quot;, cex = 0.7, pt.cex = 1, xjust = 0, yjust = 0.5)



for(age in ages[ages!=&quot;Tout âge&quot;]){
  agcl &lt;- dic.ages[age] # Get corresponding age class
  # Get predicted data for this age class (no region)
  subd &lt;- ndt.noregion[ndt.noregion$classe_age == agcl,]
  lines(subd$med14, subd$prdFin, col = colAge[age], lwd = lwd.pred)
}</code></pre>
<p><img src="communes_files/figure-html/unnamed-chunk-16-1.png" width="672" /></p>
</div>
</div>
</div>
<div id="all-times" class="section level1">
<h1>All times</h1>
<pre class="r"><code># Extract departement
dat.vaccin$dep &lt;- substr(dat.vaccin$commune_residence, start = 1, stop = 2)

# Add region 
dat.vaccin$region &lt;- NA
dat.vaccin[base::is.element(dat.vaccin$dep, c(&quot;13&quot;, &quot;83&quot;, &quot;84&quot;)), &quot;region&quot;] &lt;- &quot;PACA&quot;
dat.vaccin[base::is.element(dat.vaccin$dep, c(&quot;75&quot;, &quot;91&quot;, &quot;92&quot;, &quot;93&quot;, &quot;94&quot;, &quot;95&quot;)), &quot;region&quot;] &lt;- &quot;IDF&quot;
dat.vaccin[base::is.element(dat.vaccin$dep, c(&quot;69&quot;)), &quot;region&quot;] &lt;- &quot;ARA&quot;


dat.all.time &lt;- merge(dat.niveauVie, dat.vaccin, by = &quot;commune_residence&quot;)
nrow(dat.all.time)

dat.all.time$tx_cum_1d &lt;- as.numeric(dat.all.time$taux_cumu_1_inj)
dat.all.time$tx_cum_fin &lt;- as.numeric(dat.all.time$taux_cumu_termine)

# plot(as.Date(dat.all.time$date), dat.all.time$taux_cumu_1_inj)
# plot(as.Date(dat.all.time$date), dat.all.time$taux_cumu_termine)

dat.all.time$time &lt;- as.numeric(as.Date(dat.all.time$date) - as.Date(min(dat.all.time$date)))

is.numeric(dat.all.time$time)
is.numeric(dat.all.time$taux_cumu_1_inj)
unique(dat.all.time$taux_cumu_1_inj)


dat$classe_age &lt;- as.factor(dat$classe_age)
dat$region &lt;- as.factor(dat$region)

mdl1D &lt;- glm(formula = cbind(effectif_cumu_1_inj, population_carto - effectif_cumu_1_inj) ~ time + med14 + classe_age + med14*time + classe_age*time + region + region*time, data = dat, family = binomial(link = &quot;logit&quot;))

mdl1D.2 &lt;- glm(formula = cbind(effectif_cumu_1_inj, population_carto - effectif_cumu_1_inj) ~ time + med14 + classe_age + med14*time + classe_age*time, data = dat, family = binomial(link = &quot;logit&quot;))

mdlFin &lt;- glm(formula = cbind(effectif_cumu_termine, population_carto - effectif_cumu_termine) ~ time + med14 + classe_age + med14*time + classe_age*time + region + region*time, data = dat, family = binomial(link = &quot;logit&quot;))

mdlFin.2 &lt;- glm(formula = cbind(effectif_cumu_termine, population_carto - effectif_cumu_termine) ~ time + med14 + classe_age + med14*time + classe_age*time, data = dat, family = binomial(link = &quot;logit&quot;))

summary(mdl1D)
summary(mdlFin)
length(predict(mdl))

prd &lt;- predict(mdl1D, se.fit = TRUE)
dat$pred1D &lt;- prd$fit
dat$se1D &lt;- prd$se.fit

lgt &lt;- function(x){ exp(x) / (1 + exp(x)) }
dat$pred1D.response &lt;- lgt(dat$pred1D)
dat$pred1D.response.se.upper &lt;- lgt(dat$pred1D + 1.96 * dat$se1D)
dat$pred1D.response.se.lower &lt;- lgt(dat$pred1D - 1.96 * dat$se1D)

#with(preddat, lines(0:1000, exp(fit)/(1+exp(fit)), col=&quot;blue&quot;))
#with(preddat, lines(0:1000, exp(fit+1.96*se.fit)/(1+exp(fit+1.96*se.fit)), lty=2))
#with(preddat, lines(0:1000, exp(fit-1.96*se.fit)/(1+exp(fit-1.96*se.fit)), lty=2))


newdata &lt;- expand.grid(med14 = seq(min(dat$med14), max(dat$med14), length.out = 100), classe_age = sort(unique(dat$classe_age)), time = seq(min(dat$time), max(dat$time), length.out = 11))
nrow(newdata)

prd1D &lt;- predict(mdl1D.2, newdata = newdata, type = &quot;response&quot;)
prdFin &lt;- predict(mdlFin.2, newdata = newdata, type = &quot;response&quot;)
ifinal &lt;- which(newdata$time == max(newdata$time))

ndt &lt;- newdata[ifinal, ]
ndt$pred1D &lt;- prd1D[ifinal]
ndt$predFin &lt;- prdFin[ifinal]

unique(dat$classe_age)
unique(dat$libelle_classe_age)</code></pre>
<pre class="r"><code>dat.final &lt;- dat[which(dat$time == max(dat$time)),]

tmp &lt;- dat.final[which(dat.final$classe_age != &quot;TOUT_AGE&quot;),]
plot(tmp$med14, tmp$taux_cumu_1_inj)

mns &lt;- aggregate(as.numeric(dat.final$taux_cumu_termine), by = list(dat.final$libelle_classe_age), FUN = mean, na.rm = TRUE)
mns2 &lt;- mns[sort(mns$x, index.return = TRUE, decreasing = TRUE)$ix,]

mns2 &lt;- mns2[mns2$Group.1 != &quot;Tout âge&quot;, ]

par(mar = c(4, 3, 2, 6), las = 1)
alf &lt;- 0.5

plot(tmp$med14, tmp$taux_cumu_1_inj, col = adjustcolor(colAge[tmp$libelle_classe_age], alpha.f = alf), 
     xlab = xlb, ylab = &quot;Proportion vaccination terminée&quot;, pch = 16, yaxs = &quot;i&quot;, frame.plot = FALSE, ylim = c(0, 1))
par(xpd = TRUE)
legend(x = 1.03*max(tmp$med14), y = 1, legend = mns2$Group.1, col = adjustcolor(colAge[mns2$Group.1], alpha.f = alf), pch = 16, bty = &quot;n&quot;, cex = 0.7, pt.cex = 1, xjust = 0)

for(age in ages[ages!=&quot;Tout âge&quot;]){
  agcl &lt;- dic.ages[age]
  subd &lt;- ndt[ndt$classe_age == agcl,]
  lines(subd$med14, subd$pred1D, col = colAge[age], lwd = 2)
}

tmp[1,]

prd1D</code></pre>
<pre class="r"><code>lang &lt;- &quot;EN&quot;
if(lang == &quot;EN&quot;){
  xlb &lt;- &quot;Median income&quot;
  ylb &lt;- &quot;Proportion 1st dose&quot;
  tt &lt;- &quot;&quot;
  detailsFig &lt;- &quot;Code: https://github.com/flodebarre/covid_vaccination/blob/main/communes.Rmd
Vaccination data: https://datavaccin-covid.ameli.fr/explore/dataset/donnees-de-vaccination-par-commune
Income data: https://www.data.gouv.fr/fr/datasets/niveau-de-vie-des-francais-par-commune/&quot;
}else{
  xlb &lt;- &quot;Revenu median&quot;
  ylb &lt;- &quot;Proportion 1ere dose&quot;
  tt &lt;- &quot;&quot;
  detailsFig &lt;- &quot;Code: https://github.com/flodebarre/covid_vaccination/blob/main/communes.Rmd
Données vaccination : https://datavaccin-covid.ameli.fr/explore/dataset/donnees-de-vaccination-par-commune
Données revenus : https://www.data.gouv.fr/fr/datasets/niveau-de-vie-des-francais-par-commune/&quot;  
}</code></pre>
<pre class="r"><code>par(mar = c(5, 4, 3, 3), las = 1, mgp = c(1.75, 0.4, 0), tck = -0.02)
for(cla in unique(dat.all$libelle_classe_age)){
  subdat &lt;- dat.all[which(dat.all$libelle_classe_age == cla), ]
  plot(subdat$med14, subdat$taux_cumu_1_inj, 
       ylim = c(0, 1), 
       xlab = &quot;Revenu MED14&quot;, ylab = &quot;Proportion 1ere injection&quot;, 
       yaxs = &quot;i&quot;, pch = 16, col = adjustcolor(colRegion[subdat$region], alpha.f = 0.5), frame.plot = FALSE)
  axis(4)
  title(main = cla)
  mtext(&quot;Code: https://github.com/flodebarre/covid_vaccination/blob/main/communes.Rmd
Données vaccination : https://datavaccin-covid.ameli.fr/explore/dataset/donnees-de-vaccination-par-commune
Données revenus : https://www.data.gouv.fr/fr/datasets/niveau-de-vie-des-francais-par-commune/&quot;, side = 1, line = 4, cex = 0.6, adj = 0, col = gray(0.4))
}</code></pre>
<pre class="r"><code>#install.packages(&quot;plotly&quot;)
library(plotly)

#for(cla in unique(dat.all$libelle_classe_age)){
cla &lt;- &quot;Tout âge&quot;
  subdat &lt;- dat.all[which(dat.all$libelle_classe_age == cla), ]

fig &lt;- plot_ly(subdat, x = ~med14, y = ~taux_cumu_1_inj, type = &#39;scatter&#39;, mode = &#39;markers&#39;,
        hoverinfo = &#39;text&#39;,
        text = ~paste(commune_residence, libelle_commune.x)) %&gt;% layout(yaxis = list(title = &quot;Proportion 1ere injection&quot;), xaxis = list(title = &quot;Revenu median&quot;))
fig
fig2 &lt;- fig %&gt;% layout(yaxis = list(range = c(0, 1000), title = &quot;Proportion 1ere injection&quot;))

fig2

readline(prompt=&quot;Press [enter] to continue&quot;)


}
fig</code></pre>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
