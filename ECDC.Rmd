---
title: "ECDC Vaccination data"
author: "FD"
output: 
  html_document: 
      code_folding: hide
      toc: TRUE
      toc_float: TRUE
      self_contained: no
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
```

```{r, include = FALSE}
dlData <- FALSE
# Whether to download the data again

today <- Sys.Date()
```

# Initializations

## Graphical parameters

```{r}
# Colors
colPop <- gray(0.8) # Unvaccinated
colCompletR <- "#9B2500"
col1DR <- "#FF6939"
colCompletL <- "#044063"
col1DL <- "#4F92BA"
```

## Load data and clean data

```{r}
# Load data 
URL <- "https://opendata.ecdc.europa.eu/covid19/vaccine_tracker/csv/data.csv"


dataFile <- paste0("data/edcdc-vaccination_", today, ".csv")
if(dlData){
  download.file(URL, dataFile)
}
dat.ECDC <- read.csv(dataFile, stringsAsFactors = FALSE)
head(dat.ECDC)


# Remove regional data, keep only country data
dat.ECDC <- dat.ECDC[is.element(dat.ECDC$Region, dat.ECDC$ReportingCountry), ]


# Load country codes
# Source: https://gist.github.com/radcliff/f09c0f88344a7fcef373
# Modified for Greece (was GR, changed into EL)
cc <- read.csv("data/countryCodes.csv")
# Turn into dictionary
dic.cc <- cc$English.short.name.lower.case
names(dic.cc) <- cc$Alpha.2.code

# Add full name of the countries
dat.ECDC$Country <- dic.cc[dat.ECDC$ReportingCountry]

# Clean memory
rm(dic.cc, cc)

# Check age groups for all countries
table(dat.ECDC$Country, dat.ECDC$TargetGroup)
# Germany, The Netherlands and Liechtenstein do not share age data

# Define age classes
ac1 <- data.frame(ageClass = c("Age0_4", "Age5_9", "Age10_14", "Age15_17", "Age18_24", "Age25_49", "Age50_59", "Age60_69", "Age70_79", "Age80+"))

ac2 <- data.frame(ageClass = c("Age<18", "Age18_24", "Age25_49", "Age50_59", "Age60_69", "Age70_79", "Age80+"))

ac1$minAge <- c(0, 5, 10, 15, 18, 25, 50, 60, 70, 80)
ac1$maxAge <- c(4, 9, 14, 17, 24, 49, 59, 69, 79, 100)

ac2$minAge <- c(0, 18, 25, 50, 60, 70, 80)
ac2$maxAge <- c(17, 24, 49, 59, 69, 79, 100)

# Initialize the new dataset
newdat <- data.frame("TargetGroup" = character(0), 
                     "FirstDose" = numeric(0), 
                     "SecondDose" = numeric(0), 
                     "Population" = numeric(0), 
                     "Denominator" = numeric(0), 
                     "Country" = character(0), 
                     "ReportingCountry" = character(0), 
                     "minAge" = numeric(0), 
                     "maxAge" = numeric(0),
                     "YearWeekISO" = character(0))

#thedate <- max(dat.ECDC$YearWeekISO)
#thedate
#c1 <- "ES"

for(thedate in sort(unique(dat.ECDC$YearWeekISO))){
  for(ctr in unique(dat.ECDC$ReportingCountry)){

  tmp <- dat.ECDC[dat.ECDC$ReportingCountry == ctr & dat.ECDC$YearWeekISO <= thedate, ]
  
  if(nrow(tmp) > 1){
    # If there are data at this date!
    
      # Compute cumulated values
  agg <- aggregate(x = tmp[, c("FirstDose", "SecondDose")], by = list(TargetGroup = tmp[, "TargetGroup"]), FUN = sum)
  
  agg2 <- aggregate(x = tmp[, c("Population", "Denominator", "Country", "ReportingCountry")], by = list(TargetGroup = tmp[, "TargetGroup"]), FUN = unique)
  
  agg <- merge(agg, agg2, by = "TargetGroup")
  
  # If there is no line for Age<18, add it
  if(all(agg$TargetGroup != "Age<18")){
    agg <- rbind(agg, c("Age<18", 0, 0, agg[agg$TargetGroup == "ALL", "Population"], NA, agg[agg$TargetGroup == "ALL", "Country"], agg[agg$TargetGroup == "ALL", "ReportingCountry"]))
  }
  
  # Add Denominator to Age<18 if it is missing
  if(is.na(agg[agg$TargetGroup == "Age<18", "Denominator"])){
    agg[agg$TargetGroup == "Age<18", "Denominator"] <- as.numeric(agg[agg$TargetGroup == "ALL", "Population"]) - as.numeric(agg[agg$TargetGroup == "ALL", "Denominator"])
  }
  
  # Subselect the age class data that we need
  # Detailed age classes for children
  ac.children <- setdiff(ac1$ageClass, ac2$ageClass)
  # Subset of the data for these age classes
  tagg <- agg[is.element(agg$TargetGroup, ac.children), ]
  # NOTE: consider using "any" instead of "all" here
  if(all(is.na(tagg$Denominator))){
    # If we are missing all the population sizes, use the other age classes (ac2)
    agg <- agg[is.element(agg$TargetGroup, ac2$ageClass), ]
    # Add age class information
    agg <- merge(agg, ac2, by.x = "TargetGroup", by.y = "ageClass", all.x = TRUE)
  }else{
    # But if we have some values, use them
    agg <- agg[is.element(agg$TargetGroup, ac1$ageClass), ]
    # Add age class information
    agg <- merge(agg, ac1, by.x = "TargetGroup", by.y = "ageClass", all.x = TRUE)
  }
  agg$YearWeekISO <- thedate
  
  # Add to the new dataset
  newdat <- rbind(newdat, agg)
  }

  }
}

# Made numerical values numeric again
for(col in c("FirstDose", "SecondDose", "Population", "Denominator", "minAge", "maxAge")){
  newdat[, col] <- as.numeric(newdat[, col])
}

unique(newdat$YearWeekISO)

# Select a late date 
# (not necessarily the final one, because may be incomplete)
newdat.final <- newdat[newdat$YearWeekISO == "2021-W32", ]

# Count lines per country
tb <- table(newdat.final$Country)
# Countries without age data
missingAge <- names(tb[tb == 1])
missingAge

# Remove them from the final dataset
newdat.final <- newdat.final[!is.element(newdat.final$Country, missingAge), ]

newdat.final
```


# Plot age pyramid

```{r}
c1 <- "ES"
c2 <- "FR"

sameScale <- TRUE # Whether to plot the two countries on the same scale or not


tmp <- newdat.final[is.element(newdat.final$ReportingCountry, c(c1, c2)), ]

tmp

# Get max size of age class
tmp1 <- tmp[tmp$ReportingCountry == c1, ]
tmp2 <- tmp[tmp$ReportingCountry == c2, ]
xmax1 <- max(tmp1$Denominator)
xmax2 <- max(tmp2$Denominator)

xmax <- max(c(xmax1, xmax2))
xmax1
xmax2

if(sameScale){
  tmp1$RDenom <- tmp1$Denominator / xmax
  tmp1$R1D <- tmp1$FirstDose / xmax
  tmp1$R2D <- tmp1$SecondDose / xmax
  
  tmp2$RDenom <- tmp2$Denominator / xmax
  tmp2$R1D <- tmp2$FirstDose / xmax
  tmp2$R2D <- tmp2$SecondDose / xmax
}else{
  tmp1$RDenom <- tmp1$Denominator / xmax1
  tmp1$R1D <- tmp1$FirstDose / xmax1
  tmp1$R2D <- tmp1$SecondDose / xmax1
  
  tmp2$RDenom <- tmp2$Denominator / xmax2
  tmp2$R1D <- tmp2$FirstDose / xmax2
  tmp2$R2D <- tmp2$SecondDose / xmax2
}


# Initialize plot
plot(c(-1, 1), c(0, 100), type = "n", 
              axes = FALSE, xlab = "", ylab = "", 
         xaxs = "i")
    
    # Write Credits
    par(family = "mono")
    mtext(side = 1, line = 4.5, text = paste0("@flodebarre, adapted from @VictimOfMaths, ", today, " 
  Data ECDC: https://opendata.ecdc.europa.eu/covid19/vaccine_tracker/csv/data.csv
  Code : https://github.com/flodebarre/covid_vaccination/blob/main/pyramid_UKFR_overtime.R"), adj = 0, cex = 0.55, col = gray(0.5))
    par(family = "sans")
    
    for(ctr in c("Angleterre", "France")){
      # For each country / side of the plot
    
      if(ctr == "Angleterre"){
        factor <- factorEN
        colComplet <- colCompletEN
        col1D <- col1DEN
      }else{
        factor <- -1 * factorEN
        colComplet <- colCompletFR
        col1D <- col1DFR
      }
      
      tmp <- dat[dat$country == ctr, ]
      
      for(ag in unique(tmp$ageClass)){
        # For each age class, 
        # Subset of the data
        tmp <- dat[dat$country == ctr & dat$ageClass == ag, ]
        
        # Plot Total population
        rect(xleft = factor * tmp$pop.byY, ybottom = tmp$agemin, 
             xright = 0, ytop = tmp$agemax + 1, 
             col = colPop, border = gray(0, 0))
        
        if(version == 1){
          # Vaccinated, 1 dose
          rect(xleft = factor * (tmp$cumDose1.byY), ybottom = tmp$agemin, 
               xright = 0, ytop = tmp$agemax + 1, 
               col = col1D, border = gray(0, 0))
          
          # Vaccinated, complete
          rect(xleft = factor * tmp$cumComplet.byY, ybottom = tmp$agemin, 
               xright = 0, ytop = tmp$agemax + 1, 
               col = colComplet, border = gray(0, 0))
        }else{
          ## Full vaccination in the end
          # Vaccinated, 1 dose
          rect(xleft = factor * (tmp$pop.byY - tmp$cumDose1.byY), ybottom = tmp$agemin, 
               xright = factor * tmp$pop.byY, ytop = tmp$agemax + 1, 
               col = col1D, border = gray(0, 0))
          
          # Vaccinated, complete
          rect(xleft = factor * (tmp$pop.byY - tmp$cumComplet.byY), ybottom = tmp$agemin, 
               xright = factor * tmp$pop.byY, ytop = tmp$agemax + 1, 
               col = colComplet, border = gray(0, 0))
          
        }
        
        # Graduations for age class
        lines(c(factor*10^6, 0), rep(tmp$agemin, 2), col = "white", lwd = 1.5)
        # Age values
        par(xpd = TRUE)
        text(x = factor*10^6, y = tmp$agemin, labels = tmp$agemin, col = gray(0), adj = c(0.5, 0.25), cex = 0.9)
        par(xpd = FALSE)
        
      }
      # Add country legend
      par(xpd = TRUE)
      if(factor == -1){adjj <- 0}else{adjj <- 1}
      text(x = factor * 10^6, y = 110, labels = ctr, adj = c(adjj, 0), cex = 1.3, font = 2)
      par(xpd = FALSE)
      
    }
    


```


